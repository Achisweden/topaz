-----------------------------------
-- Area: Kazham
-- NPC: Roropp
-- Standard Info NPC
-----------------------------------
require("scripts/globals/pathfind");

local path =
{
    {16.031977, -8.000000, -106.132980, 0, 0},
    {16.257568, -8.000000, -105.056381, 0, 0},
    {16.488544, -8.000000, -103.993233, 0, 0},
    {16.736769, -8.000000, -102.925789, 0, 0},
    {16.683693, -8.000000, -103.979767, 0, 0},
    {16.548674, -8.000000, -105.063362, 0, 0},
    {16.395681, -8.000000, -106.140511, 0, 0},
    {16.232897, -8.000000, -107.264717, 0, 0},
    {15.467215, -8.000000, -111.498398, 0, 0},
    {14.589552, -8.000000, -110.994324, 0, 0},
    {15.159187, -8.000000, -111.843941, 0, 0},
    {14.467873, -8.000000, -110.962730, 0, 0},
    {15.174071, -8.000000, -111.862633, 0, 0},
    {14.541949, -8.000000, -111.057007, 0, 0},
    {14.902087, -8.000000, -110.084839, 0, 0},
    {16.047390, -8.000000, -109.979256, 0, 0},
    {15.778022, -8.000000, -111.043304, 0, 0},
    {14.890110, -8.000000, -111.671753, 0, 0},
    {14.021555, -8.000000, -112.251015, 0, 0},
    {14.686207, -8.000000, -111.499725, 0, 0},
    {14.093862, -8.000000, -110.499420, 0, 0},
    {13.680259, -8.000000, -109.391823, 0, 0},
    {13.557489, -8.000000, -108.379669, 0, 0},
    {13.505498, -8.000000, -107.381012, 0, 0},
    {13.459559, -8.000000, -106.253922, 0, 0},
    {13.316416, -8.000000, -103.526192, 0, 0},
    {13.187886, -8.000000, -104.739197, 0, 0},
    {13.107801, -8.000000, -105.800117, 0, 0},
    {12.796517, -8.000000, -112.526253, 0, 0},
    {13.832601, -8.000000, -112.296143, 0, 0},
    {14.750398, -8.000000, -111.783379, 0, 0},
    {15.670343, -8.000000, -111.165863, 0, 0},
    {16.603874, -8.000000, -110.633209, 0, 0},
    {16.092684, -8.000000, -111.518547, 0, 0},
    {14.989306, -8.000000, -111.488846, 0, 0},
    {14.200422, -8.000000, -110.700859, 0, 0},
    {13.893030, -8.000000, -109.573753, 0, 0},
    {14.125311, -8.000000, -108.444000, 0, 0},
    {14.459513, -8.000000, -107.450630, 0, 0},
    {14.801712, -8.000000, -106.489639, 0, 0},
    {15.278582, -8.000000, -101.082420, 0, 0},
    {14.444073, -8.000000, -101.823395, 0, 0},
    {13.716499, -8.000000, -102.551468, 0, 0},
    {13.602413, -8.000000, -103.671387, 0, 0},
    {13.773719, -8.000000, -104.753410, 0, 0},
    {14.019071, -8.000000, -105.842079, 0, 0},
    {14.275101, -8.000000, -106.944748, 0, 0},
    {15.256051, -8.000000, -111.604820, 0, 0},
    {14.447664, -8.000000, -110.851128, 0, 0},
    {15.032362, -8.000000, -111.679832, 0, 0},
    {14.342421, -8.000000, -110.802597, 0, 0},
    {13.347830, -8.000000, -111.075569, 0, 0},
    {12.911378, -8.000000, -112.149437, 0, 0},
    {13.853123, -8.000000, -112.719269, 0, 0},
    {14.862821, -8.000000, -112.491272, 0, 0},
    {14.661202, -8.000000, -111.423317, 0, 0},
    {14.026034, -8.000000, -110.421486, 0, 0},
    {13.683197, -8.000000, -109.474442, 0, 0},
    {13.565609, -8.000000, -108.425598, 0, 0},
    {13.508922, -8.000000, -107.411247, 0, 0},
    {13.463074, -8.000000, -106.340248, 0, 0},
    {13.314778, -8.000000, -103.679779, 0, 0},
    {13.196125, -8.000000, -104.712784, 0, 0},
    {13.107168, -8.000000, -105.817261, 0, 0},
    {12.642462, -8.000000, -112.284569, 0, 0},
    {12.722448, -8.000000, -111.167519, 0, 0},
    {12.800394, -8.000000, -110.082321, 0, 0},
    {13.358773, -8.000000, -103.535522, 0, 0},
    {13.700077, -8.000000, -104.534401, 0, 0},
    {13.968060, -8.000000, -105.588699, 0, 0},
    {14.196942, -8.000000, -106.594994, 0, 0},
    {14.446990, -8.000000, -107.686691, 0, 0},
    {14.850841, -8.000000, -109.436707, 0, 0},
    {15.239276, -8.000000, -111.548279, 0, 0},
    {14.406080, -8.000000, -110.805321, 0, 0},
    {15.076430, -8.000000, -111.739746, 0, 0},
    {14.353576, -8.000000, -110.817177, 0, 0},
    {13.903994, -8.000000, -109.854828, 0, 0},
    {14.002557, -8.000000, -108.838097, 0, 0},
    {14.350549, -8.000000, -107.686317, 0, 0},
    {14.707720, -8.000000, -106.730751, 0, 0},
    {15.101375, -8.000000, -105.648056, 0, 0},
    {15.192271, -8.000000, -101.161407, 0, 0},
    {14.369474, -8.000000, -101.891479, 0, 0},
    {13.749530, -8.000000, -102.797821, 0, 0},
    {13.968772, -8.000000, -103.829323, 0, 0},
    {14.469959, -8.000000, -104.888268, 0, 0},
    {14.964800, -8.000000, -105.802879, 0, 0},
    {16.955986, -8.000000, -109.414169, 0, 0},
    {16.776617, -8.000000, -110.478836, 0, 0},
    {16.263479, -8.000000, -111.339577, 0, 0},
    {15.200941, -8.000000, -111.526329, 0, 0},
    {14.352178, -8.000000, -110.754326, 0, 0},
    {15.190737, -8.000000, -110.001801, 0, 0},
    {16.302240, -8.000000, -110.005722, 0, 0},
    {15.815475, -8.000000, -111.014900, 0, 0},
    {14.911292, -8.000000, -111.661888, 0, 0},
    {14.005045, -8.000000, -112.263855, 0, 0},
    {14.883535, -8.000000, -111.781982, 0, 0},
    {14.404255, -8.000000, -110.876640, 0, 0},
    {15.071056, -8.000000, -111.731522, 0, 0},
    {14.335340, -8.000000, -110.793587, 0, 0},
    {13.342915, -8.000000, -111.184967, 0, 0},
    {12.869198, -8.000000, -112.210732, 0, 0},
    {13.971279, -8.000000, -112.223083, 0, 0},
    {14.902745, -8.000000, -111.661880, 0, 0},
    {15.813969, -8.000000, -111.060051, 0, 0},
    {16.728361, -8.000000, -110.402679, 0, 0},
    {16.754343, -8.000000, -109.357780, 0, 0},
    {16.393435, -8.000000, -108.410202, 0, 0},
    {15.880263, -8.000000, -107.455299, 0, 0},
    {15.362660, -8.000000, -106.521095, 0, 0},
    {13.593607, -8.000000, -103.312202, 0, 0},
    {14.028812, -8.000000, -102.335686, 0, 0},
    {14.836555, -8.000000, -101.487602, 0, 0},
    {15.656289, -8.000000, -100.748199, 0, 0},
    {14.859239, -8.000000, -101.459091, 0, 0},
    {13.961225, -8.000000, -102.255051, 0, 0},
    {14.754376, -8.000000, -101.551842, 0, 0},
    {15.574628, -8.000000, -100.824944, 0, 0},
    {15.371163, -8.000000, -101.005310, 0, 0},
    {13.802610, -8.000000, -102.395645, 0, 0},
    {13.852294, -8.000000, -103.601982, 0, 0},
    {14.296268, -8.000000, -104.610878, 0, 0},
    {14.826925, -8.000000, -105.560638, 0, 0},
    {15.320851, -8.000000, -106.448463, 0, 0},
    {15.858366, -8.000000, -107.421883, 0, 0},
    {17.018456, -8.000000, -109.527451, 0, 0},
    {16.734596, -8.000000, -110.580498, 0, 0},
    {16.095715, -8.000000, -111.542282, 0, 0}
}

function onSpawn(npc)
    npc:initNpcPathing(path[1][1], path[1][2], path[1][3])
    onPath(npc)
end

function onPath(npc)
    tpz.path.randomPoint(npc, path, 0)
end


function onTrade(player,npc,trade)
    -- item IDs
    -- 483       Broken Mithran Fishing Rod
    -- 22        Workbench
    -- 1008      Ten of Coins
    -- 1157      Sands of Silence
    -- 1158      Wandering Bulb
    -- 904       Giant Fish Bones
    -- 4599      Blackened Toad
    -- 905       Wyvern Skull
    -- 1147      Ancient Salt
    -- 4600      Lucky Egg
    local OpoOpoAndIStatus = player:getQuestStatus(OUTLANDS, tpz.quest.id.outlands.THE_OPO_OPO_AND_I)
    local progress = player:getCharVar("OPO_OPO_PROGRESS")
    local failed = player:getCharVar("OPO_OPO_FAILED")
    local goodtrade = trade:hasItemQty(1157,1)
    local badtrade = (trade:hasItemQty(483,1) or trade:hasItemQty(22,1) or trade:hasItemQty(1008,1) or trade:hasItemQty(1158,1) or trade:hasItemQty(904,1) or trade:hasItemQty(4599,1) or trade:hasItemQty(905,1) or trade:hasItemQty(1147,1) or trade:hasItemQty(4600,1))

    if (OpoOpoAndIStatus == QUEST_ACCEPTED) then
        if progress == 3 or failed == 4 then
            if goodtrade then
                player:startEvent(222)
                npc:pathStop()
            elseif badtrade then
                player:startEvent(232)
                npc:pathStop()
            end
        end
    end
end

function onTrigger(player,npc)
    local OpoOpoAndIStatus = player:getQuestStatus(OUTLANDS, tpz.quest.id.outlands.THE_OPO_OPO_AND_I)
    local progress = player:getCharVar("OPO_OPO_PROGRESS")
    local failed = player:getCharVar("OPO_OPO_FAILED")
    local retry = player:getCharVar("OPO_OPO_RETRY")

    if (OpoOpoAndIStatus == QUEST_ACCEPTED) then
        if retry >= 1 then                          -- has failed on future npc so disregard previous successful trade
            player:startEvent(200)
            npc:pathStop()
        elseif (progress == 3 or failed == 4) then
                player:startEvent(210)  -- asking for sands of silence
                npc:pathStop()
        elseif (progress >= 4 or failed >= 5) then
            player:startEvent(245) -- happy with sands of silence
            npc:pathStop()
        end
    else
        player:startEvent(200)
        npc:pathStop()
    end
end

function onEventUpdate(player,csid,option)
end

function onEventFinish(player,csid,option,npc)

    if (csid == 222) then    -- correct trade, onto next opo
        if player:getCharVar("OPO_OPO_PROGRESS") == 3 then
            player:tradeComplete()
            player:setCharVar("OPO_OPO_PROGRESS",4)
            player:setCharVar("OPO_OPO_FAILED",0)
        else
            player:setCharVar("OPO_OPO_FAILED",5)
        end
    elseif (csid == 232) then              -- wrong trade, restart at first opo
        player:setCharVar("OPO_OPO_FAILED",1)
        player:setCharVar("OPO_OPO_RETRY",4)
    end

    npc:pathResume()
end
